name: Add Document

on:
  issues:
    types: [labeled]

jobs:
  add-document:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body and extract account URL
        id: parse
        run: |
          # Read the issue body
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          # Extract the first non-empty line as the name
          NAME=$(echo "$ISSUE_BODY" | awk '/^### e.g., Office Hours$/ {getline; while($0 ~ /^$/) getline; print; exit}' | xargs)
          
          # Read the URL
          DOCUMENT_URL=$(echo "$ISSUE_BODY" | awk '/^### Document URL$/ {getline; while($0 ~ /^$/) getline; print; exit}' | xargs)
            
          if [[ -z "$NAME" || -z "$DOCUMENT_URL" ]]; then
            echo "Invalid submission. Name or URL missing."
            exit 1
          fi
          
          echo "NAME=$NAME" >> $GITHUB_ENV
          echo "DOCUMENT_URL=$DOCUMENT_URL" >> $GITHUB_ENV

      - name: Ensure documents.json exists
        run: |
          if [ ! -f documents.json ]; then
            echo '{"documents":[]}' > documents.json
          fi

      - name: Add document to documents.json
        run: |
          # Skip if the document already exists
          if jq -e --arg url "$DOCUMENT_URL" '.documents[]? | select(.url == $url)' documents.json >/dev/null; then
            echo "Document already exists. Skipping."
            exit 0
          fi

          # Append the document
          jq --arg name "$NAME" --arg url "$DOCUMENT_URL" \
            '.documents += [{"name": $name, "url": $url}]' documents.json > documents.tmp.json
          mv documents.tmp.json documents.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add documents.json
          git commit -m "Add document: $DOCUMENT_URL" || echo "No changes to commit"
          git push

      - name: Close issue using GitHub CLI
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --comment "âœ… This document has been approved and added to the list. Thanks for submitting!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
